{% extends "document.njk" %}

{% block content %}
<style>
  .cv-dashboard {
    display: flex;
    flex-direction: column;
    gap: var(--space-l, 1.5rem);
  }

  .cv-save-banner {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-primary-container, #e6f0ff);
    border: 2px solid var(--color-primary, #0066cc);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem) var(--space-m, 1rem);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-s, 0.75rem);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .cv-save-banner__text {
    font: var(--font-body, 0.875rem/1.4 sans-serif);
    font-weight: 600;
  }

  .cv-accordion {
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.5rem);
    overflow: hidden;
  }

  .cv-accordion__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-m, 1rem) var(--space-m, 1.5rem);
    cursor: pointer;
    user-select: none;
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    font: var(--font-heading, bold 1.125rem/1.4 sans-serif);
    color: var(--color-on-surface, inherit);
  }

  .cv-accordion__header:hover {
    background: var(--color-primary-container, #e6f0ff);
  }

  .cv-accordion__chevron {
    transition: transform 0.2s;
    width: 20px;
    height: 20px;
  }

  .cv-accordion[open] .cv-accordion__chevron {
    transform: rotate(180deg);
  }

  .cv-accordion__body {
    padding: 0 var(--space-m, 1.5rem) var(--space-m, 1.5rem);
  }

  .cv-accordion__desc {
    color: var(--color-on-offset, #666);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    margin-block-end: var(--space-s, 0.75rem);
  }

  .cv-sortable-list {
    display: flex;
    flex-direction: column;
  }

  .cv-sortable-item {
    transition: opacity 0.15s;
  }

  .cv-sortable-ghost {
    opacity: 0.3;
    background: var(--color-primary-container, #e6f0ff);
    border-radius: var(--border-radius-small, 0.25rem);
  }

  .cv-sortable-ghost .cv-edit-details {
    display: none;
  }

  .cv-sortable-chosen {
    opacity: 0.9;
  }

  .cv-item {
    background: var(--color-background, #fff);
    border: 1px solid var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-xs, 0.5rem);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-s, 0.75rem);
  }

  .cv-item--has-edit {
    margin-block-end: 0;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .cv-item__info {
    flex: 1;
    min-width: 0;
  }

  .cv-item__title {
    font-weight: 600;
    margin-block-end: 0.125rem;
  }

  .cv-item__sub {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
  }

  .cv-item__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-block-start: 0.25rem;
  }

  .cv-tag {
    display: inline-block;
    background: var(--color-primary-container, #e6f0ff);
    color: var(--color-on-primary-container, #003380);
    font: var(--font-caption, 0.75rem/1.2 sans-serif);
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
  }

  .cv-item__actions {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
    align-items: center;
    flex-wrap: wrap;
  }

  .drag-handle {
    cursor: grab;
    color: var(--color-on-offset, #999);
    padding: 0.25rem;
    display: flex;
    align-items: center;
    flex-shrink: 0;
    touch-action: none;
  }

  .drag-handle:hover {
    color: var(--color-primary, #0066cc);
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .cv-edit-details {
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .cv-edit-details summary {
    display: none;
  }

  .cv-edit-details .cv-form {
    margin-block-start: 0;
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    border-color: var(--color-primary, #0066cc);
    border-style: solid;
    border-width: 0 1px 1px 1px;
  }

  .cv-form {
    background: var(--color-background, #fff);
    border: 1px dashed var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-start: var(--space-s, 0.75rem);
  }

  .cv-form h4 {
    font: var(--font-subhead, bold 0.875rem/1.4 sans-serif);
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .cv-form .field {
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .cv-form .field__label {
    display: block;
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    font-weight: 600;
    margin-block-end: 0.25rem;
  }

  .cv-form .field__input {
    width: 100%;
    padding: var(--space-2xs, 0.375rem) var(--space-xs, 0.5rem);
    border: 1px solid var(--color-outline-variant, #ccc);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    background: var(--color-background, #fff);
    color: var(--color-on-surface, inherit);
  }

  .cv-form .field__input:focus {
    border-color: var(--color-primary, #0066cc);
    outline: 2px solid var(--color-primary, #0066cc);
    outline-offset: -2px;
  }

  .cv-form select.field__input {
    appearance: auto;
  }

  .cv-form textarea.field__input {
    resize: vertical;
    min-height: 4rem;
  }

  .cv-form .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-xs, 0.5rem);
  }

  .cv-form__buttons {
    display: flex;
    gap: 0.5rem;
    margin-block-start: var(--space-xs, 0.5rem);
  }

  .cv-empty {
    color: var(--color-on-offset, #999);
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
    text-align: center;
    padding: var(--space-s, 0.75rem);
  }

  .cv-success {
    background: var(--color-success-container, #d4edda);
    border: 1px solid var(--color-success, #28a745);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .cv-error {
    background: var(--color-error-container, #f8d7da);
    border: 1px solid var(--color-error, #dc3545);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }
</style>

<header class="page-header">
  <h1 class="page-header__title">{{ __("cv.title") }}</h1>
  <p class="page-header__description">{{ __("cv.description") }}</p>
</header>

{% if request.query.saved %}
<div class="cv-success">
  <p>{{ __("cv.saved") }}</p>
</div>
{% endif %}

{% if request.query.error %}
<div class="cv-error">
  <p>An error occurred. Please try again.</p>
</div>
{% endif %}

{% if cv.lastUpdated %}
<p class="cv-accordion__desc">{{ __("cv.lastUpdated") }}: {{ cv.lastUpdated }}</p>
{% endif %}

{# Hidden save form for drag-drop reordering - shown when order changes #}
<form method="post" action="{{ cvEndpoint }}/save" id="cv-save-form" style="display:none">
  <input type="hidden" name="experience" id="experience-json" value="{{ cv.experience | dump | e }}">
  <input type="hidden" name="projects" id="projects-json" value="{{ cv.projects | dump | e }}">
  <input type="hidden" name="education" id="education-json" value="{{ cv.education | dump | e }}">
  <input type="hidden" name="languages" id="languages-json" value="{{ cv.languages | dump | e }}">
  {% for category, items in cv.skills | dictsort %}
  <input type="hidden" name="skills[{{ category }}]" value="{{ items | join(', ') }}">
  {% endfor %}
  <input type="hidden" name="interests" value="{{ cv.interests | join(', ') }}">
  <div class="cv-save-banner">
    <span class="cv-save-banner__text">Order changed — drag more or save now</span>
    <button type="submit" class="button button--primary">Save All Changes</button>
  </div>
</form>

<div class="cv-dashboard">

  {# ===== EXPERIENCE ===== #}
  <details class="cv-accordion" id="experience" {% if not cv.experience.length %}open{% endif %}>
    <summary class="cv-accordion__header">
      {{ __("cv.experience.title") }} ({{ cv.experience.length or 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.experience.description") }}</p>

      {% if cv.experience.length %}
      <div class="cv-sortable-list" id="experience-sortable">
        {% for item in cv.experience %}
        <div class="cv-sortable-item" data-index="{{ loop.index0 }}">
          <div class="cv-item cv-item--has-edit">
            <span class="drag-handle" title="Drag to reorder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
            </span>
            <div class="cv-item__info">
              <div class="cv-item__title">{{ item.title }}</div>
              <div class="cv-item__sub">
                {{ item.company }}{% if item.location %} &middot; {{ item.location }}{% endif %}
                {% if item.startDate %} &middot; {{ item.startDate }}{% if item.endDate %} – {{ item.endDate }}{% else %} – Present{% endif %}{% endif %}
                {% if item.type %} &middot; {{ item.type }}{% endif %}
              </div>
              {% if item.description %}
              <div class="cv-item__sub" style="margin-top:0.25rem">{{ item.description }}</div>
              {% endif %}
              {% if item.highlights and item.highlights.length %}
              <div class="cv-item__tags">
                {% for h in item.highlights %}<span class="cv-tag">{{ h }}</span>{% endfor %}
              </div>
              {% endif %}
            </div>
            <div class="cv-item__actions">
              <button type="button" class="button button--small" onclick="var d=this.closest('.cv-sortable-item').querySelector('.cv-edit-details');d.open=!d.open">{{ __("cv.experience.edit") }}</button>
              <form method="post" action="{{ cvEndpoint }}/experience/{{ loop.index0 }}/delete" style="margin:0">
                <button type="submit" class="button button--small button--secondary" onclick="return confirm('Delete this entry?')">Delete</button>
              </form>
            </div>
          </div>
          <details class="cv-edit-details">
            <summary></summary>
            <div class="cv-form">
              <form method="post" action="{{ cvEndpoint }}/experience/{{ loop.index0 }}/edit">
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.jobTitle") }}</label>
                    <input class="field__input" type="text" name="title" value="{{ item.title }}" required>
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.company") }}</label>
                    <input class="field__input" type="text" name="company" value="{{ item.company }}" required>
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.location") }}</label>
                    <input class="field__input" type="text" name="location" value="{{ item.location }}">
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.type") }}</label>
                    <select class="field__input" name="type">
                      <option value="full-time" {% if item.type == "full-time" %}selected{% endif %}>Full-time</option>
                      <option value="part-time" {% if item.type == "part-time" %}selected{% endif %}>Part-time</option>
                      <option value="contract" {% if item.type == "contract" %}selected{% endif %}>Contract</option>
                      <option value="freelance" {% if item.type == "freelance" %}selected{% endif %}>Freelance</option>
                      <option value="volunteer" {% if item.type == "volunteer" %}selected{% endif %}>Volunteer</option>
                      <option value="internship" {% if item.type == "internship" %}selected{% endif %}>Internship</option>
                    </select>
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.startDate") }}</label>
                    <input class="field__input" type="month" name="startDate" value="{{ item.startDate }}">
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.endDate") }}</label>
                    <input class="field__input" type="month" name="endDate" value="{{ item.endDate }}">
                  </div>
                </div>
                <div class="field">
                  <label class="field__label">{{ __("cv.experience.descriptionField") }}</label>
                  <textarea class="field__input" name="description" rows="2">{{ item.description }}</textarea>
                </div>
                <div class="field">
                  <label class="field__label">{{ __("cv.experience.highlights") }}</label>
                  <textarea class="field__input" name="highlights" rows="3" placeholder="One highlight per line">{{ item.highlights | join("\n") if item.highlights }}</textarea>
                </div>
                <div class="cv-form__buttons">
                  <button type="submit" class="button button--primary button--small">{{ __("cv.save") }}</button>
                  <button type="button" class="button button--small button--secondary" onclick="this.closest('details').open=false">Cancel</button>
                </div>
              </form>
            </div>
          </details>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="cv-empty">{{ __("cv.noData") }}</p>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.experience.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/experience/add">
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="exp-title">{{ __("cv.experience.jobTitle") }}</label>
              <input class="field__input" type="text" id="exp-title" name="title" required>
            </div>
            <div class="field">
              <label class="field__label" for="exp-company">{{ __("cv.experience.company") }}</label>
              <input class="field__input" type="text" id="exp-company" name="company" required>
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="exp-location">{{ __("cv.experience.location") }}</label>
              <input class="field__input" type="text" id="exp-location" name="location">
            </div>
            <div class="field">
              <label class="field__label" for="exp-type">{{ __("cv.experience.type") }}</label>
              <select class="field__input" id="exp-type" name="type">
                <option value="full-time">Full-time</option>
                <option value="part-time">Part-time</option>
                <option value="contract">Contract</option>
                <option value="freelance">Freelance</option>
                <option value="volunteer">Volunteer</option>
                <option value="internship">Internship</option>
              </select>
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="exp-start">{{ __("cv.experience.startDate") }}</label>
              <input class="field__input" type="month" id="exp-start" name="startDate">
            </div>
            <div class="field">
              <label class="field__label" for="exp-end">{{ __("cv.experience.endDate") }}</label>
              <input class="field__input" type="month" id="exp-end" name="endDate">
            </div>
          </div>
          <div class="field">
            <label class="field__label" for="exp-desc">{{ __("cv.experience.descriptionField") }}</label>
            <textarea class="field__input" id="exp-desc" name="description" rows="2"></textarea>
          </div>
          <div class="field">
            <label class="field__label" for="exp-highlights">{{ __("cv.experience.highlights") }}</label>
            <textarea class="field__input" id="exp-highlights" name="highlights" rows="3" placeholder="One highlight per line"></textarea>
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.experience.add") }}</button>
        </form>
      </div>
    </div>
  </details>

  {# ===== PROJECTS ===== #}
  <details class="cv-accordion" id="projects">
    <summary class="cv-accordion__header">
      {{ __("cv.projects.title") }} ({{ cv.projects.length or 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.projects.description") }}</p>

      {% if cv.projects.length %}
      <div class="cv-sortable-list" id="projects-sortable">
        {% for item in cv.projects %}
        <div class="cv-sortable-item" data-index="{{ loop.index0 }}">
          <div class="cv-item cv-item--has-edit">
            <span class="drag-handle" title="Drag to reorder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
            </span>
            <div class="cv-item__info">
              <div class="cv-item__title">
                {% if item.url %}<a href="{{ item.url }}">{{ item.name }}</a>{% else %}{{ item.name }}{% endif %}
              </div>
              <div class="cv-item__sub">
                {% if item.status %}<span class="cv-tag">{{ item.status }}</span>{% endif %}
                {% if item.startDate %} &middot; {{ item.startDate }}{% if item.endDate %} – {{ item.endDate }}{% else %} – Present{% endif %}{% endif %}
                {% if item.description %} {{ item.description }}{% endif %}
              </div>
              {% if item.technologies and item.technologies.length %}
              <div class="cv-item__tags">
                {% for t in item.technologies %}<span class="cv-tag">{{ t }}</span>{% endfor %}
              </div>
              {% endif %}
            </div>
            <div class="cv-item__actions">
              <button type="button" class="button button--small" onclick="var d=this.closest('.cv-sortable-item').querySelector('.cv-edit-details');d.open=!d.open">{{ __("cv.projects.edit") }}</button>
              <form method="post" action="{{ cvEndpoint }}/projects/{{ loop.index0 }}/delete" style="margin:0">
                <button type="submit" class="button button--small button--secondary" onclick="return confirm('Delete this entry?')">Delete</button>
              </form>
            </div>
          </div>
          <details class="cv-edit-details">
            <summary></summary>
            <div class="cv-form">
              <form method="post" action="{{ cvEndpoint }}/projects/{{ loop.index0 }}/edit">
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.projects.name") }}</label>
                    <input class="field__input" type="text" name="name" value="{{ item.name }}" required>
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.projects.url") }}</label>
                    <input class="field__input" type="url" name="url" value="{{ item.url }}" placeholder="https://...">
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.startDate") }}</label>
                    <input class="field__input" type="month" name="startDate" value="{{ item.startDate }}">
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.endDate") }}</label>
                    <input class="field__input" type="month" name="endDate" value="{{ item.endDate }}">
                  </div>
                </div>
                <div class="field">
                  <label class="field__label">{{ __("cv.projects.descriptionField") }}</label>
                  <textarea class="field__input" name="description" rows="2">{{ item.description }}</textarea>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.projects.tags") }}</label>
                    <input class="field__input" type="text" name="tags" value="{{ item.technologies | join(', ') if item.technologies }}" placeholder="Docker, Node.js, Python">
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.projects.status") }}</label>
                    <select class="field__input" name="status">
                      <option value="active" {% if item.status == "active" %}selected{% endif %}>Active</option>
                      <option value="maintained" {% if item.status == "maintained" %}selected{% endif %}>Maintained</option>
                      <option value="archived" {% if item.status == "archived" %}selected{% endif %}>Archived</option>
                      <option value="completed" {% if item.status == "completed" %}selected{% endif %}>Completed</option>
                    </select>
                  </div>
                </div>
                <div class="cv-form__buttons">
                  <button type="submit" class="button button--primary button--small">{{ __("cv.save") }}</button>
                  <button type="button" class="button button--small button--secondary" onclick="this.closest('details').open=false">Cancel</button>
                </div>
              </form>
            </div>
          </details>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="cv-empty">{{ __("cv.noData") }}</p>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.projects.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/projects/add">
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="proj-name">{{ __("cv.projects.name") }}</label>
              <input class="field__input" type="text" id="proj-name" name="name" required>
            </div>
            <div class="field">
              <label class="field__label" for="proj-url">{{ __("cv.projects.url") }}</label>
              <input class="field__input" type="url" id="proj-url" name="url" placeholder="https://...">
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="proj-start">{{ __("cv.experience.startDate") }}</label>
              <input class="field__input" type="month" id="proj-start" name="startDate">
            </div>
            <div class="field">
              <label class="field__label" for="proj-end">{{ __("cv.experience.endDate") }}</label>
              <input class="field__input" type="month" id="proj-end" name="endDate">
            </div>
          </div>
          <div class="field">
            <label class="field__label" for="proj-desc">{{ __("cv.projects.descriptionField") }}</label>
            <textarea class="field__input" id="proj-desc" name="description" rows="2"></textarea>
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="proj-tags">{{ __("cv.projects.tags") }}</label>
              <input class="field__input" type="text" id="proj-tags" name="tags" placeholder="Docker, Node.js, Python">
            </div>
            <div class="field">
              <label class="field__label" for="proj-status">{{ __("cv.projects.status") }}</label>
              <select class="field__input" id="proj-status" name="status">
                <option value="active">Active</option>
                <option value="maintained">Maintained</option>
                <option value="archived">Archived</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.projects.add") }}</button>
        </form>
      </div>
    </div>
  </details>

  {# ===== SKILLS ===== #}
  <details class="cv-accordion" id="skills">
    <summary class="cv-accordion__header">
      {{ __("cv.skills.title") }} ({{ cv.skills | dictsort | length if cv.skills else 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.skills.description") }}</p>

      {% if cv.skills and (cv.skills | dictsort | length) %}
        {% for category, items in cv.skills | dictsort %}
        <div class="cv-item">
          <div class="cv-item__info">
            <div class="cv-item__title">{{ category }}</div>
            <div class="cv-item__tags">
              {% for skill in items %}<span class="cv-tag">{{ skill }}</span>{% endfor %}
            </div>
          </div>
          <form method="post" action="{{ cvEndpoint }}/skills/{{ category | urlencode }}/delete" style="margin:0">
            <button type="submit" class="button button--small button--secondary" onclick="return confirm('Delete this category?')">Delete</button>
          </form>
        </div>
        {% endfor %}
      {% else %}
        <p class="cv-empty">{{ __("cv.noData") }}</p>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.skills.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/skills/add">
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="skill-cat">{{ __("cv.skills.category") }}</label>
              <input class="field__input" type="text" id="skill-cat" name="category" required placeholder="e.g. Programming Languages">
            </div>
            <div class="field">
              <label class="field__label" for="skill-items">{{ __("cv.skills.items") }}</label>
              <input class="field__input" type="text" id="skill-items" name="items" required placeholder="Python, JavaScript, Go">
            </div>
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.skills.add") }}</button>
        </form>
      </div>
    </div>
  </details>

  {# ===== EDUCATION ===== #}
  <details class="cv-accordion" id="education">
    <summary class="cv-accordion__header">
      {{ __("cv.education.title") }} ({{ cv.education.length or 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.education.description") }}</p>

      {% if cv.education.length %}
      <div class="cv-sortable-list" id="education-sortable">
        {% for item in cv.education %}
        <div class="cv-sortable-item" data-index="{{ loop.index0 }}">
          <div class="cv-item cv-item--has-edit">
            <span class="drag-handle" title="Drag to reorder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
            </span>
            <div class="cv-item__info">
              <div class="cv-item__title">{{ item.degree }}</div>
              <div class="cv-item__sub">
                {{ item.institution }}{% if item.location %} &middot; {{ item.location }}{% endif %}
                {% if item.startDate %} &middot; {{ item.startDate }}{% if item.endDate %} – {{ item.endDate }}{% else %} – Present{% endif %}{% elif item.year %} &middot; {{ item.year }}{% endif %}
              </div>
              {% if item.description %}
              <div class="cv-item__sub" style="margin-top:0.25rem">{{ item.description }}</div>
              {% endif %}
            </div>
            <div class="cv-item__actions">
              <button type="button" class="button button--small" onclick="var d=this.closest('.cv-sortable-item').querySelector('.cv-edit-details');d.open=!d.open">{{ __("cv.education.edit") }}</button>
              <form method="post" action="{{ cvEndpoint }}/education/{{ loop.index0 }}/delete" style="margin:0">
                <button type="submit" class="button button--small button--secondary" onclick="return confirm('Delete this entry?')">Delete</button>
              </form>
            </div>
          </div>
          <details class="cv-edit-details">
            <summary></summary>
            <div class="cv-form">
              <form method="post" action="{{ cvEndpoint }}/education/{{ loop.index0 }}/edit">
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.education.degree") }}</label>
                    <input class="field__input" type="text" name="degree" value="{{ item.degree }}" required>
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.education.institution") }}</label>
                    <input class="field__input" type="text" name="institution" value="{{ item.institution }}" required>
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.education.location") }}</label>
                    <input class="field__input" type="text" name="location" value="{{ item.location }}">
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.startDate") }}</label>
                    <input class="field__input" type="month" name="startDate" value="{{ item.startDate }}">
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.experience.endDate") }}</label>
                    <input class="field__input" type="month" name="endDate" value="{{ item.endDate }}">
                  </div>
                </div>
                <div class="field">
                  <label class="field__label">{{ __("cv.education.descriptionField") }}</label>
                  <textarea class="field__input" name="description" rows="2">{{ item.description }}</textarea>
                </div>
                <div class="cv-form__buttons">
                  <button type="submit" class="button button--primary button--small">{{ __("cv.save") }}</button>
                  <button type="button" class="button button--small button--secondary" onclick="this.closest('details').open=false">Cancel</button>
                </div>
              </form>
            </div>
          </details>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="cv-empty">{{ __("cv.noData") }}</p>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.education.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/education/add">
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="edu-degree">{{ __("cv.education.degree") }}</label>
              <input class="field__input" type="text" id="edu-degree" name="degree" required>
            </div>
            <div class="field">
              <label class="field__label" for="edu-inst">{{ __("cv.education.institution") }}</label>
              <input class="field__input" type="text" id="edu-inst" name="institution" required>
            </div>
          </div>
          <div class="field">
            <label class="field__label" for="edu-location">{{ __("cv.education.location") }}</label>
            <input class="field__input" type="text" id="edu-location" name="location">
          </div>
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="edu-start">{{ __("cv.experience.startDate") }}</label>
              <input class="field__input" type="month" id="edu-start" name="startDate">
            </div>
            <div class="field">
              <label class="field__label" for="edu-end">{{ __("cv.experience.endDate") }}</label>
              <input class="field__input" type="month" id="edu-end" name="endDate">
            </div>
          </div>
          <div class="field">
            <label class="field__label" for="edu-desc">{{ __("cv.education.descriptionField") }}</label>
            <textarea class="field__input" id="edu-desc" name="description" rows="2"></textarea>
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.education.add") }}</button>
        </form>
      </div>
    </div>
  </details>

  {# ===== LANGUAGES ===== #}
  <details class="cv-accordion" id="languages">
    <summary class="cv-accordion__header">
      {{ __("cv.languages.title") }} ({{ cv.languages.length or 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.languages.description") }}</p>

      {% if cv.languages.length %}
      <div class="cv-sortable-list" id="languages-sortable">
        {% for item in cv.languages %}
        <div class="cv-sortable-item" data-index="{{ loop.index0 }}">
          <div class="cv-item cv-item--has-edit">
            <span class="drag-handle" title="Drag to reorder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>
            </span>
            <div class="cv-item__info">
              <div class="cv-item__title">{{ item.name }}</div>
              <div class="cv-item__sub">{{ item.level }}</div>
            </div>
            <div class="cv-item__actions">
              <button type="button" class="button button--small" onclick="var d=this.closest('.cv-sortable-item').querySelector('.cv-edit-details');d.open=!d.open">{{ __("cv.languages.edit") }}</button>
              <form method="post" action="{{ cvEndpoint }}/languages/{{ loop.index0 }}/delete" style="margin:0">
                <button type="submit" class="button button--small button--secondary" onclick="return confirm('Delete this entry?')">Delete</button>
              </form>
            </div>
          </div>
          <details class="cv-edit-details">
            <summary></summary>
            <div class="cv-form">
              <form method="post" action="{{ cvEndpoint }}/languages/{{ loop.index0 }}/edit">
                <div class="field-row">
                  <div class="field">
                    <label class="field__label">{{ __("cv.languages.name") }}</label>
                    <input class="field__input" type="text" name="name" value="{{ item.name }}" required>
                  </div>
                  <div class="field">
                    <label class="field__label">{{ __("cv.languages.level") }}</label>
                    <select class="field__input" name="level">
                      <option value="native" {% if item.level == "native" %}selected{% endif %}>Native</option>
                      <option value="fluent" {% if item.level == "fluent" %}selected{% endif %}>Fluent</option>
                      <option value="advanced" {% if item.level == "advanced" %}selected{% endif %}>Advanced</option>
                      <option value="intermediate" {% if item.level == "intermediate" %}selected{% endif %}>Intermediate</option>
                      <option value="basic" {% if item.level == "basic" %}selected{% endif %}>Basic</option>
                    </select>
                  </div>
                </div>
                <div class="cv-form__buttons">
                  <button type="submit" class="button button--primary button--small">{{ __("cv.save") }}</button>
                  <button type="button" class="button button--small button--secondary" onclick="this.closest('details').open=false">Cancel</button>
                </div>
              </form>
            </div>
          </details>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <p class="cv-empty">{{ __("cv.noData") }}</p>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.languages.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/languages/add">
          <div class="field-row">
            <div class="field">
              <label class="field__label" for="lang-name">{{ __("cv.languages.name") }}</label>
              <input class="field__input" type="text" id="lang-name" name="name" required>
            </div>
            <div class="field">
              <label class="field__label" for="lang-level">{{ __("cv.languages.level") }}</label>
              <select class="field__input" id="lang-level" name="level">
                <option value="native">Native</option>
                <option value="fluent">Fluent</option>
                <option value="advanced">Advanced</option>
                <option value="intermediate" selected>Intermediate</option>
                <option value="basic">Basic</option>
              </select>
            </div>
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.languages.add") }}</button>
        </form>
      </div>
    </div>
  </details>

  {# ===== INTERESTS ===== #}
  <details class="cv-accordion" id="interests">
    <summary class="cv-accordion__header">
      {{ __("cv.interests.title") }} ({{ cv.interests.length or 0 }})
      <svg class="cv-accordion__chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </summary>
    <div class="cv-accordion__body">
      <p class="cv-accordion__desc">{{ __("cv.interests.description") }}</p>

      {% if cv.interests.length %}
      <div class="cv-item">
        <div class="cv-item__info">
          <div class="cv-item__tags">
            {% for interest in cv.interests %}<span class="cv-tag">{{ interest }}</span>{% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <div class="cv-form">
        <h4>{{ __("cv.interests.add") }}</h4>
        <form method="post" action="{{ cvEndpoint }}/save">
          {# Pass through all existing data to preserve it #}
          <input type="hidden" name="experience" value="{{ cv.experience | dump | e }}">
          <input type="hidden" name="projects" value="{{ cv.projects | dump | e }}">
          <input type="hidden" name="education" value="{{ cv.education | dump | e }}">
          <input type="hidden" name="languages" value="{{ cv.languages | dump | e }}">
          {# Skills need special handling - pass as JSON #}
          {% for category, items in cv.skills | dictsort %}
          <input type="hidden" name="skills[{{ category }}]" value="{{ items | join(', ') }}">
          {% endfor %}
          <div class="field">
            <label class="field__label" for="interests-input">{{ __("cv.interests.placeholder") }}</label>
            <input class="field__input" type="text" id="interests-input" name="interests" value="{{ cv.interests | join(', ') }}" placeholder="Open Source, IndieWeb, Music">
          </div>
          <button type="submit" class="button button--primary button--small">{{ __("cv.save") }}</button>
        </form>
      </div>
    </div>
  </details>

</div>

<script>
(function() {
  var cvData = {
    experience: JSON.parse(document.getElementById('experience-json').value || '[]'),
    projects: JSON.parse(document.getElementById('projects-json').value || '[]'),
    education: JSON.parse(document.getElementById('education-json').value || '[]'),
    languages: JSON.parse(document.getElementById('languages-json').value || '[]')
  };

  var saveForm = document.getElementById('cv-save-form');
  var dirty = false;

  function showSaveBanner() {
    if (!dirty) {
      dirty = true;
      saveForm.style.display = '';
    }
  }

  function syncSection(sectionName) {
    var list = document.getElementById(sectionName + '-sortable');
    if (!list) return;
    var items = list.querySelectorAll('.cv-sortable-item');
    var data = cvData[sectionName];
    var ordered = [];
    items.forEach(function(el) {
      var idx = parseInt(el.dataset.index, 10);
      if (data[idx]) ordered.push(data[idx]);
    });
    cvData[sectionName] = ordered;
    // Reset indices to sequential for next drag
    items.forEach(function(el, i) { el.dataset.index = i; });
    document.getElementById(sectionName + '-json').value = JSON.stringify(ordered);
    showSaveBanner();
  }

  // Load SortableJS from CDN
  var script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js';
  script.onload = function() {
    ['experience', 'projects', 'education', 'languages'].forEach(function(section) {
      var el = document.getElementById(section + '-sortable');
      if (!el || !el.children.length) return;
      new Sortable(el, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'cv-sortable-ghost',
        chosenClass: 'cv-sortable-chosen',
        draggable: '.cv-sortable-item',
        onEnd: function() { syncSection(section); }
      });
    });
  };
  document.head.appendChild(script);
})();
</script>
{% endblock %}
