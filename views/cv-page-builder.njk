{% extends "document.njk" %}

{% block content %}
<style>
  .hp-dashboard {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl, 2rem);
  }

  .hp-section {
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.5rem);
    padding: var(--space-m, 1.5rem);
  }

  .hp-section h2 {
    font: var(--font-heading, bold 1.25rem/1.4 sans-serif);
    margin-block-end: var(--space-s, 0.75rem);
    padding-block-end: var(--space-xs, 0.5rem);
    border-block-end: 1px solid var(--color-outline-variant, #ddd);
  }

  .hp-section__desc {
    color: var(--color-on-offset, #666);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    margin-block-end: var(--space-s, 0.75rem);
  }

  .hp-layout-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-s, 0.75rem);
  }

  .hp-layout-option {
    background: var(--color-background, #fff);
    border: 2px solid var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.5rem);
    padding: var(--space-s, 0.75rem);
    cursor: pointer;
    transition: border-color 0.2s;
    text-align: center;
  }

  .hp-layout-option:hover {
    border-color: var(--color-primary, #0066cc);
  }

  .hp-layout-option.selected {
    border-color: var(--color-primary, #0066cc);
    background: var(--color-primary-container, #e6f0ff);
  }

  .hp-layout-option input {
    display: none;
  }

  .hp-layout-option svg {
    width: 80px;
    height: 60px;
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .hp-sections-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs, 0.5rem);
  }

  .hp-section-item {
    background: var(--color-background, #fff);
    border: 1px solid var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-s, 0.75rem);
  }

  .hp-section-item--has-edit {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    margin-block-end: 0;
  }

  .hp-section-item__info {
    flex: 1;
  }

  .hp-section-item__name {
    font-weight: 600;
  }

  .hp-section-item__type {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
  }

  .hp-section-item__preview {
    color: var(--color-on-offset, #888);
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    margin-block-start: 0.125rem;
    max-width: 40ch;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .hp-section-item__actions {
    display: flex;
    gap: var(--space-2xs, 0.25rem);
    flex-shrink: 0;
  }

  .hp-section-item__drag {
    cursor: grab;
    color: var(--color-on-offset, #999);
    padding: 0 0.25rem;
    display: flex;
    align-items: center;
  }

  .hp-section-item__drag:active {
    cursor: grabbing;
  }

  .hp-section-item.sortable-ghost {
    opacity: 0.4;
    background: var(--color-primary-container, #e6f0ff);
  }

  .hp-section-item.sortable-chosen {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .hp-edit-panel {
    background: var(--color-background, #fff);
    border: 1px solid var(--color-primary, #0066cc);
    border-top: none;
    border-radius: 0 0 var(--border-radius-small, 0.25rem) var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .hp-edit-panel summary { display: none; }

  .hp-edit-panel .field {
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .hp-edit-panel .field__label {
    display: block;
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    font-weight: 600;
    margin-block-end: 0.25rem;
  }

  .hp-edit-panel .field__input {
    width: 100%;
    padding: var(--space-2xs, 0.375rem) var(--space-xs, 0.5rem);
    border: 1px solid var(--color-outline-variant, #ccc);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    background: var(--color-background, #fff);
    color: var(--color-on-surface, inherit);
  }

  .hp-edit-panel textarea.field__input {
    resize: vertical;
    min-height: 6rem;
    font-family: monospace;
    font-size: 0.8125rem;
  }

  .hp-edit-panel__buttons {
    display: flex;
    gap: 0.5rem;
    margin-block-start: var(--space-xs, 0.5rem);
  }

  .hp-section-picker {
    margin-block-start: var(--space-m, 1rem);
    padding: var(--space-s, 0.75rem);
    background: var(--color-background, #fff);
    border: 1px dashed var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.25rem);
  }

  .hp-section-picker h3 {
    font: var(--font-subhead, bold 1rem/1.4 sans-serif);
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .hp-section-picker__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: var(--space-xs, 0.5rem);
  }

  .hp-section-picker__item {
    background: var(--color-offset, #f5f5f5);
    border: 1px solid var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-xs, 0.5rem);
    cursor: pointer;
    text-align: center;
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
  }

  .hp-section-picker__item:hover {
    background: var(--color-primary-container, #e6f0ff);
    border-color: var(--color-primary, #0066cc);
  }

  .hp-section-picker__heading {
    grid-column: 1 / -1;
    font-weight: bold;
    margin-top: 0.5rem;
    font: var(--font-caption, 0.8rem/1.4 sans-serif);
    color: var(--color-on-offset, #555);
  }

  .hp-empty {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
    text-align: center;
    padding: var(--space-m, 1rem);
  }

  .hp-success {
    background: var(--color-success-container, #d4edda);
    border: 1px solid var(--color-success, #28a745);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .hp-preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: var(--space-s, 0.75rem);
  }

  .hp-preset-card {
    background: var(--color-background, #fff);
    border: 2px solid var(--color-outline-variant, #ddd);
    border-radius: var(--border-radius-small, 0.5rem);
    padding: var(--space-m, 1.25rem);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2xs, 0.375rem);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .hp-preset-card:hover {
    border-color: var(--color-primary, #0066cc);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .hp-preset-card--active {
    border-color: var(--color-primary, #0066cc);
    background: var(--color-primary-container, #e6f0ff);
  }

  .hp-preset-card__icon {
    color: var(--color-primary, #0066cc);
    margin-block-end: var(--space-2xs, 0.25rem);
  }

  .hp-preset-card__label {
    font-weight: 700;
    font-size: 1rem;
  }

  .hp-preset-card__desc {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.8rem/1.4 sans-serif);
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .hp-preset-card__badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    font-weight: 600;
    background: var(--color-primary, #0066cc);
    color: #fff;
    border-radius: 1rem;
  }
</style>

<header class="page-header">
  <h1 class="page-header__title">{{ __("cvPageBuilder.title") }}</h1>
  <p class="page-header__description">{{ __("cvPageBuilder.description") }}</p>
</header>

{# Back link to CV Dashboard #}
<div style="margin-block-end: var(--space-m, 1rem);">
  <a href="{{ cvEndpoint }}" class="button button--secondary button--small" style="display: inline-flex; align-items: center; gap: 0.5rem;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    {{ __("cvPageBuilder.backLink") }}
  </a>
</div>

{% include "partials/cv-tab-nav.njk" %}

{% if request.query.saved %}
<div class="hp-success">
  <p>{{ __("cvPageBuilder.saved") }}</p>
</div>
{% endif %}

{# Quick Start Presets #}
{% if presets and presets.length %}
<section class="hp-section" style="margin-block-end: var(--space-xl, 2rem);">
  <h2>{{ __("cvPageBuilder.presets.label") }}</h2>
  <p class="hp-section__desc">{{ __("cvPageBuilder.presets.description") }}</p>

  <div class="hp-preset-grid">
    {% for preset in presets %}
    <form method="post" action="{{ cvEndpoint }}/page/preset" class="hp-preset-card {% if activePresetId == preset.id %}hp-preset-card--active{% endif %}">
      <input type="hidden" name="presetId" value="{{ preset.id }}">
      <div class="hp-preset-card__icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          {% if preset.id == "professional-cv" %}
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
          {% elif preset.id == "full-portfolio" %}
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          {% elif preset.id == "minimal" %}
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>
          {% endif %}
        </svg>
      </div>
      <div class="hp-preset-card__label">{{ preset.label }}</div>
      <div class="hp-preset-card__desc">{{ preset.description }}</div>
      {% if activePresetId == preset.id %}
      <div class="hp-preset-card__badge">Active</div>
      {% else %}
      <button type="submit" class="button button--small">Apply</button>
      {% endif %}
    </form>
    {% endfor %}
    {# Custom card — shown as active when config doesn't match any preset #}
    <div class="hp-preset-card {% if not activePresetId %}hp-preset-card--active{% endif %}">
      <div class="hp-preset-card__icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/>
          <line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/>
        </svg>
      </div>
      <div class="hp-preset-card__label">Custom</div>
      <div class="hp-preset-card__desc">Your personalized configuration</div>
      {% if not activePresetId %}
      <div class="hp-preset-card__badge">Active</div>
      {% endif %}
    </div>
  </div>
</section>
{% endif %}

<form method="post" action="{{ cvEndpoint }}/page/save" class="hp-dashboard" id="hp-form">
  {# Layout Selection #}
  <section class="hp-section">
    <h2>{{ __("cvPageBuilder.layout.label") }}</h2>
    <div class="hp-layout-grid">
      {% for layout in layouts %}
      <label class="hp-layout-option {% if config.layout == layout.id %}selected{% endif %}">
        <input type="radio" name="layout" value="{{ layout.id }}" {% if config.layout == layout.id %}checked{% endif %}>
        {% if layout.id == "single-column" %}
        <svg viewBox="0 0 80 60"><rect x="10" y="5" width="60" height="50" fill="#ddd" stroke="#999"/></svg>
        {% elif layout.id == "two-column" %}
        <svg viewBox="0 0 80 60"><rect x="5" y="5" width="45" height="50" fill="#ddd" stroke="#999"/><rect x="55" y="5" width="20" height="50" fill="#eee" stroke="#999"/></svg>
        {% else %}
        <svg viewBox="0 0 80 60"><rect x="5" y="5" width="70" height="20" fill="#ddd" stroke="#999"/><rect x="5" y="30" width="32" height="25" fill="#eee" stroke="#999"/><rect x="42" y="30" width="32" height="25" fill="#eee" stroke="#999"/></svg>
        {% endif %}
        <div>{{ layout.label }}</div>
      </label>
      {% endfor %}
    </div>
  </section>

  {# Hero Configuration #}
  <section class="hp-section">
    <h2>{{ __("cvPageBuilder.hero.label") }}</h2>
    <div class="field">
      <label class="field__label">
        <input type="checkbox" name="hero[enabled]" value="true" {% if config.hero.enabled %}checked{% endif %}>
        {{ __("cvPageBuilder.hero.enabled") }}
      </label>
    </div>
    <div class="field">
      <label class="field__label">
        <input type="checkbox" name="hero[showSocial]" value="true" {% if config.hero.showSocial %}checked{% endif %}>
        {{ __("cvPageBuilder.hero.showSocial") }}
      </label>
    </div>
  </section>

  {# Content Sections #}
  <section class="hp-section">
    <h2>{{ __("cvPageBuilder.sections.label") }}</h2>
    <p class="hp-section__desc">{{ __("cvPageBuilder.sections.description") }}</p>

    <ul class="hp-sections-list" id="sections-list"></ul>

    <div class="hp-section-picker">
      <h3>{{ __("cvPageBuilder.sections.addSection") }}</h3>
      <div class="hp-section-picker__grid">
        {% for section in sections %}
        <div class="hp-section-picker__item" data-add-section="{{ section.id }}">
          {{ section.label }}
        </div>
        {% endfor %}
      </div>
    </div>

    <input type="hidden" name="sections" id="sections-json" value='{{ config.sections | dump }}'>
  </section>

  {# Sidebar Widgets #}
  <section class="hp-section">
    <h2>{{ __("cvPageBuilder.sidebar.label") }}</h2>
    <p class="hp-section__desc">{{ __("cvPageBuilder.sidebar.description") }}</p>

    <ul class="hp-sections-list" id="widgets-list"></ul>

    <div class="hp-section-picker">
      <h3>{{ __("cvPageBuilder.sidebar.addWidget") }}</h3>
      <div class="hp-section-picker__grid">
        {% for widget in widgets %}
        <div class="hp-section-picker__item" data-add-widget="{{ widget.id }}">
          {{ widget.label }}
        </div>
        {% endfor %}
      </div>
    </div>

    <input type="hidden" name="sidebar" id="sidebar-json" value='{{ config.sidebar | dump }}'>
  </section>

  {# Footer #}
  <section class="hp-section">
    <h2>{{ __("cvPageBuilder.footer.label") }}</h2>
    <p class="hp-section__desc">{{ __("cvPageBuilder.footer.description") }}</p>

    <ul class="hp-sections-list" id="footer-list"></ul>

    <div class="hp-section-picker" id="footer-picker">
      <h3>{{ __("cvPageBuilder.footer.addColumn") }}</h3>
      <div class="hp-section-picker__grid">
        {% for section in sections %}
        <div class="hp-section-picker__item" data-add-footer="{{ section.id }}">
          {{ section.label }}
        </div>
        {% endfor %}
      </div>
    </div>
    <p class="hp-empty" id="footer-full-msg" style="display:none">{{ __("cvPageBuilder.footer.maxColumns") }}</p>

    <input type="hidden" name="footer" id="footer-json" value='{{ config.footer | dump }}'>
  </section>

  {# Save Button #}
  <div class="button-group">
    <button type="submit" class="button button--primary">{{ __("cvPageBuilder.save") }}</button>
  </div>
</form>

<script>
  // Label lookup maps
  var sectionLabels = {
    {% for section in sections %}{{ section.id | dump | safe }}: {{ section.label | dump | safe }}{% if not loop.last %}, {% endif %}{% endfor %}
  };
  var widgetLabels = {
    {% for widget in widgets %}{{ widget.id | dump | safe }}: {{ widget.label | dump | safe }}{% if not loop.last %}, {% endif %}{% endfor %}
  };
  var allLabels = Object.assign({}, sectionLabels, widgetLabels);

  // Unique key counter for tracking items
  var nextKey = 0;

  // Parse current data from hidden inputs and assign keys
  var cvPageSections = JSON.parse(document.getElementById('sections-json').value || '[]');
  var cvPageSidebar = JSON.parse(document.getElementById('sidebar-json').value || '[]');
  var cvPageFooter = JSON.parse(document.getElementById('footer-json').value || '[]');

  cvPageSections.forEach(function(s) { s._key = nextKey++; });
  cvPageSidebar.forEach(function(s) { s._key = nextKey++; });
  cvPageFooter.forEach(function(s) { s._key = nextKey++; });

  // Strip _key before form submission
  function stripKeys(items) {
    return items.map(function(item) {
      var copy = {};
      for (var k in item) {
        if (k !== '_key') copy[k] = item[k];
      }
      return copy;
    });
  }

  // Create drag handle SVG
  function createDragHandle() {
    var drag = document.createElement('span');
    drag.className = 'hp-section-item__drag drag-handle';
    drag.title = 'Drag to reorder';
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '16');
    svg.setAttribute('height', '16');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('fill', 'currentColor');
    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z');
    svg.appendChild(path);
    drag.appendChild(svg);
    return drag;
  }

  // Create a list item element for a section/widget/footer item
  function createItemElement(item, labels, removeFn, editFn) {
    var isCustom = (item.type === 'custom-html');
    var container = document.createDocumentFragment();

    var li = document.createElement('li');
    li.className = 'hp-section-item' + (isCustom ? ' hp-section-item--has-edit' : '');
    li.dataset.key = item._key;
    li.dataset.type = item.type;

    li.appendChild(createDragHandle());

    var info = document.createElement('div');
    info.className = 'hp-section-item__info';

    var name = document.createElement('span');
    name.className = 'hp-section-item__name';
    name.textContent = labels[item.type] || item.type;
    info.appendChild(name);

    var typeSpan = document.createElement('span');
    typeSpan.className = 'hp-section-item__type';
    typeSpan.textContent = ' ' + item.type;
    info.appendChild(typeSpan);

    // Show content preview for custom-html
    if (isCustom && item.config && item.config.content) {
      var preview = document.createElement('div');
      preview.className = 'hp-section-item__preview';
      var previewText = item.config.title ? item.config.title + ': ' : '';
      previewText += item.config.content.replace(/<[^>]*>/g, '').substring(0, 60);
      preview.textContent = previewText;
      info.appendChild(preview);
    }

    li.appendChild(info);

    var actions = document.createElement('div');
    actions.className = 'hp-section-item__actions';

    if (isCustom) {
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'button button--small';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', function() {
        var panel = li.nextElementSibling;
        if (panel && panel.tagName === 'DETAILS') {
          panel.open = !panel.open;
        }
      });
      actions.appendChild(editBtn);
    }

    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'button button--small button--secondary';
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', function() { removeFn(item._key); });
    actions.appendChild(removeBtn);

    li.appendChild(actions);
    container.appendChild(li);

    // Add edit panel for custom-html
    if (isCustom) {
      var details = document.createElement('details');
      details.className = 'hp-edit-panel';

      var summary = document.createElement('summary');
      details.appendChild(summary);

      var titleField = document.createElement('div');
      titleField.className = 'field';
      var titleLabel = document.createElement('label');
      titleLabel.className = 'field__label';
      titleLabel.textContent = 'Title';
      var titleInput = document.createElement('input');
      titleInput.className = 'field__input';
      titleInput.type = 'text';
      titleInput.placeholder = 'e.g. Webring, Links';
      titleInput.value = (item.config && item.config.title) || '';
      titleField.appendChild(titleLabel);
      titleField.appendChild(titleInput);
      details.appendChild(titleField);

      var contentField = document.createElement('div');
      contentField.className = 'field';
      var contentLabel = document.createElement('label');
      contentLabel.className = 'field__label';
      contentLabel.textContent = 'HTML Content';
      var contentInput = document.createElement('textarea');
      contentInput.className = 'field__input';
      contentInput.rows = 6;
      contentInput.placeholder = '<p>Your HTML here...</p>';
      contentInput.value = (item.config && item.config.content) || '';
      contentField.appendChild(contentLabel);
      contentField.appendChild(contentInput);
      details.appendChild(contentField);

      var buttons = document.createElement('div');
      buttons.className = 'hp-edit-panel__buttons';

      var saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.className = 'button button--primary button--small';
      saveBtn.textContent = 'Save';
      saveBtn.addEventListener('click', function() {
        editFn(item._key, {
          title: titleInput.value,
          content: contentInput.value
        });
        details.open = false;
      });

      var cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'button button--small button--secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() { details.open = false; });

      buttons.appendChild(saveBtn);
      buttons.appendChild(cancelBtn);
      details.appendChild(buttons);

      container.appendChild(details);
    }

    return container;
  }

  // Render a list of items into a UL element
  function renderList(listEl, items, labels, removeFn, editFn, emptyText) {
    listEl.textContent = '';
    if (items.length === 0) {
      var li = document.createElement('li');
      li.className = 'hp-empty';
      li.textContent = emptyText;
      listEl.appendChild(li);
    } else {
      items.forEach(function(item) {
        listEl.appendChild(createItemElement(item, labels, removeFn, editFn));
      });
    }
  }

  // --- Sections ---
  function addSection(id) {
    var item = { type: id, config: {}, _key: nextKey++ };
    cvPageSections.push(item);
    updateSections();
    if (id === 'custom-html') {
      var list = document.getElementById('sections-list');
      var lastPanel = list.querySelector('details.hp-edit-panel:last-of-type');
      if (lastPanel) lastPanel.open = true;
    }
  }

  function removeSection(key) {
    cvPageSections = cvPageSections.filter(function(s) { return s._key !== key; });
    updateSections();
  }

  function editSection(key, config) {
    var item = cvPageSections.find(function(s) { return s._key === key; });
    if (item) item.config = config;
    updateSections();
  }

  function updateSections() {
    document.getElementById('sections-json').value = JSON.stringify(stripKeys(cvPageSections));
    renderList(
      document.getElementById('sections-list'),
      cvPageSections, allLabels, removeSection, editSection,
      'No sections added yet. Click a section below to add it.'
    );
    initSortable();
  }

  // --- Sidebar ---
  function addWidget(id) {
    var item = { type: id, config: {}, _key: nextKey++ };
    cvPageSidebar.push(item);
    updateWidgets();
    if (id === 'custom-html') {
      var list = document.getElementById('widgets-list');
      var lastPanel = list.querySelector('details.hp-edit-panel:last-of-type');
      if (lastPanel) lastPanel.open = true;
    }
  }

  function removeWidget(key) {
    cvPageSidebar = cvPageSidebar.filter(function(w) { return w._key !== key; });
    updateWidgets();
  }

  function editWidget(key, config) {
    var item = cvPageSidebar.find(function(s) { return s._key === key; });
    if (item) item.config = config;
    updateWidgets();
  }

  function updateWidgets() {
    document.getElementById('sidebar-json').value = JSON.stringify(stripKeys(cvPageSidebar));
    renderList(
      document.getElementById('widgets-list'),
      cvPageSidebar, allLabels, removeWidget, editWidget,
      'No widgets added yet. Click a widget below to add it.'
    );
    initSortable();
  }

  // --- Footer (max 3 columns) ---
  var FOOTER_MAX = 3;

  function addFooter(id) {
    if (cvPageFooter.length >= FOOTER_MAX) return;
    var item = { type: id, config: {}, _key: nextKey++ };
    cvPageFooter.push(item);
    updateFooter();
    if (id === 'custom-html') {
      var list = document.getElementById('footer-list');
      var lastPanel = list.querySelector('details.hp-edit-panel:last-of-type');
      if (lastPanel) lastPanel.open = true;
    }
  }

  function removeFooter(key) {
    cvPageFooter = cvPageFooter.filter(function(f) { return f._key !== key; });
    updateFooter();
  }

  function editFooter(key, config) {
    var item = cvPageFooter.find(function(s) { return s._key === key; });
    if (item) item.config = config;
    updateFooter();
  }

  function updateFooter() {
    document.getElementById('footer-json').value = JSON.stringify(stripKeys(cvPageFooter));
    renderList(
      document.getElementById('footer-list'),
      cvPageFooter, allLabels, removeFooter, editFooter,
      'No footer columns added yet. Click a section below to add it.'
    );
    var picker = document.getElementById('footer-picker');
    var fullMsg = document.getElementById('footer-full-msg');
    if (picker) picker.style.display = cvPageFooter.length >= FOOTER_MAX ? 'none' : '';
    if (fullMsg) fullMsg.style.display = cvPageFooter.length >= FOOTER_MAX ? '' : 'none';
    initSortable();
  }

  // --- Sync after drag (preserves config by reordering JS array) ---
  function syncFromDom(listEl, dataArray) {
    var items = listEl.querySelectorAll('.hp-section-item');
    var ordered = [];
    items.forEach(function(el) {
      var key = parseInt(el.dataset.key, 10);
      var item = dataArray.find(function(s) { return s._key === key; });
      if (item) ordered.push(item);
    });
    return ordered;
  }

  function syncSectionsFromDom() {
    cvPageSections = syncFromDom(document.getElementById('sections-list'), cvPageSections);
    document.getElementById('sections-json').value = JSON.stringify(stripKeys(cvPageSections));
  }

  function syncSidebarFromDom() {
    cvPageSidebar = syncFromDom(document.getElementById('widgets-list'), cvPageSidebar);
    document.getElementById('sidebar-json').value = JSON.stringify(stripKeys(cvPageSidebar));
  }

  function syncFooterFromDom() {
    cvPageFooter = syncFromDom(document.getElementById('footer-list'), cvPageFooter);
    document.getElementById('footer-json').value = JSON.stringify(stripKeys(cvPageFooter));
  }

  // --- Layout selection ---
  document.querySelectorAll('.hp-layout-option').forEach(function(option) {
    option.addEventListener('click', function() {
      document.querySelectorAll('.hp-layout-option').forEach(function(o) { o.classList.remove('selected'); });
      option.classList.add('selected');
    });
  });

  // --- Section picker event delegation ---
  document.querySelectorAll('[data-add-section]').forEach(function(el) {
    el.addEventListener('click', function() { addSection(el.dataset.addSection); });
  });
  document.querySelectorAll('[data-add-widget]').forEach(function(el) {
    el.addEventListener('click', function() { addWidget(el.dataset.addWidget); });
  });
  document.querySelectorAll('[data-add-footer]').forEach(function(el) {
    el.addEventListener('click', function() { addFooter(el.dataset.addFooter); });
  });

  // --- Hero checkboxes → JSON on submit ---
  document.getElementById('hp-form').addEventListener('submit', function(e) {
    var heroEnabled = document.querySelector('input[name="hero[enabled]"]').checked;
    var heroShowSocial = document.querySelector('input[name="hero[showSocial]"]').checked;

    var heroInput = document.createElement('input');
    heroInput.type = 'hidden';
    heroInput.name = 'hero';
    heroInput.value = JSON.stringify({ enabled: heroEnabled, showSocial: heroShowSocial });
    this.appendChild(heroInput);

    document.querySelectorAll('input[name^="hero["]').forEach(function(i) { i.name = ''; });
  });

  // --- SortableJS ---
  function initSortable() {
    if (typeof Sortable === 'undefined') return;

    var lists = [
      { el: 'sections-list', sync: syncSectionsFromDom },
      { el: 'widgets-list', sync: syncSidebarFromDom },
      { el: 'footer-list', sync: syncFooterFromDom }
    ];

    lists.forEach(function(cfg) {
      var el = document.getElementById(cfg.el);
      if (!el) return;
      if (el._sortable) el._sortable.destroy();
      el._sortable = new Sortable(el, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        draggable: '.hp-section-item',
        onEnd: cfg.sync
      });
    });
  }

  // Load SortableJS from CDN
  var sortableScript = document.createElement('script');
  sortableScript.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js';
  sortableScript.onload = function() {
    initSortable();
  };
  document.head.appendChild(sortableScript);

  // --- Initial render ---
  updateSections();
  updateWidgets();
  updateFooter();
</script>
{% endblock %}
